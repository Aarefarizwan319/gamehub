<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MiniCraft Sandbox</title>
  <style>
    :root {
      --toolbar-height: 64px;
      --toolbar-bg: #222c;
      --toolbar-scroll-bg: #111c;
      --block-size: 32px;
      --player-size: 28px;
      --ui-accent: #4caf50;
      --ui-bg: #222e;
      --ui-fg: #fff;
      --day-bg: #87ceeb;
      --night-bg: #1a2340;
      --sun-color: #ffe066;
      --moon-color: #e0eaff;
      --star-color: #fff;
      --rain-color: #7ec8e3;
      --snow-color: #fff;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--day-bg);
      font-family: 'Segoe UI', Arial, sans-serif;
      user-select: none;
      touch-action: none;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }
    #game-container {
      flex: 1 1 auto;
      position: relative;
      background: linear-gradient(var(--day-bg), var(--night-bg));
      overflow: hidden;
      min-height: 0;
    }
    #game-canvas {
      width: 100vw;
      height: 100vh;
      display: block;
      background: transparent;
      touch-action: none;
    }
    #toolbar {
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      height: var(--toolbar-height);
      min-width: 240px;
      max-width: 90vw;
      background: var(--toolbar-bg);
      border-radius: 16px 16px 0 0;
      display: flex;
      align-items: center;
      overflow-x: auto;
      z-index: 10;
      box-shadow: 0 -2px 8px #0006;
      padding: 0 8px;
      scrollbar-width: thin;
    }
    #toolbar::-webkit-scrollbar {
      height: 8px;
      background: var(--toolbar-scroll-bg);
    }
    #toolbar::-webkit-scrollbar-thumb {
      background: var(--ui-accent);
      border-radius: 4px;
    }
    .toolbar-block {
      width: 48px;
      height: 48px;
      margin: 0 4px;
      border-radius: 8px;
      border: 2px solid transparent;
      background: #333c;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: border 0.2s;
      position: relative;
    }
    .toolbar-block.selected {
      border: 2px solid var(--ui-accent);
      background: #222e;
    }
    .toolbar-block .count {
      position: absolute;
      bottom: 2px;
      right: 6px;
      font-size: 0.8em;
      color: #fff;
      background: #222a;
      border-radius: 4px;
      padding: 0 4px;
      pointer-events: none;
    }
    #tool-toggle {
      position: absolute;
      left: 8px;
      bottom: 80px;
      z-index: 12;
      background: var(--ui-bg);
      color: var(--ui-fg);
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #0006;
      cursor: pointer;
      transition: background 0.2s;
    }
    #tool-toggle.active {
      background: var(--ui-accent);
      color: #fff;
    }
    #fullscreen-btn, #zoom-in-btn, #zoom-out-btn, #mute-btn, #craft-btn, #save-btn, #load-btn {
      position: absolute;
      right: 8px;
      z-index: 12;
      background: var(--ui-bg);
      color: var(--ui-fg);
      border: none;
      border-radius: 12px;
      width: 44px;
      height: 44px;
      font-size: 1.2em;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px #0006;
      cursor: pointer;
      transition: background 0.2s;
    }
    #fullscreen-btn { bottom: 8px; }
    #zoom-in-btn { bottom: 60px; }
    #zoom-out-btn { bottom: 112px; }
    #mute-btn { bottom: 164px; }
    #craft-btn { bottom: 216px; }
    #save-btn { bottom: 268px; }
    #load-btn { bottom: 320px; }
    #crafting-modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--ui-bg);
      color: var(--ui-fg);
      border-radius: 16px;
      box-shadow: 0 4px 32px #000a;
      padding: 24px 16px 16px 16px;
      z-index: 100;
      min-width: 260px;
      min-height: 180px;
      display: none;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.3s;
    }
    #crafting-modal.active {
      display: flex;
    }
    #crafting-modal h2 {
      margin: 0 0 12px 0;
      font-size: 1.2em;
      color: var(--ui-accent);
    }
    #crafting-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      margin-bottom: 8px;
    }
    .craft-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #333a;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .craft-item:hover {
      background: var(--ui-accent);
      color: #fff;
    }
    .craft-item .recipe {
      font-size: 0.9em;
      color: #ccc;
      margin-left: 8px;
    }
    #close-crafting {
      margin-top: 8px;
      background: var(--ui-accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1em;
      cursor: pointer;
    }
    #mobile-controls {
      position: absolute;
      left: 0;
      bottom: 80px;
      width: 100vw;
      height: 120px;
      z-index: 20;
      pointer-events: none;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    .joystick {
      width: 100px;
      height: 100px;
      margin-left: 12px;
      background: #222a;
      border-radius: 50%;
      position: relative;
      pointer-events: auto;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .joystick-inner {
      width: 48px;
      height: 48px;
      background: var(--ui-accent);
      border-radius: 50%;
      position: absolute;
      left: 26px;
      top: 26px;
      transition: left 0.1s, top 0.1s;
      pointer-events: none;
    }
    .mobile-btns {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-right: 12px;
      gap: 12px;
      pointer-events: auto;
    }
    .mobile-btn {
      width: 56px;
      height: 56px;
      background: var(--ui-accent);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px #0006;
      cursor: pointer;
      pointer-events: auto;
      opacity: 0.85;
      transition: background 0.2s;
    }
    .mobile-btn:active {
      background: #388e3c;
    }
    @media (max-width: 700px) {
      #toolbar {
        min-width: 120px;
        max-width: 98vw;
        height: 56px;
      }
      .toolbar-block {
        width: 36px;
        height: 36px;
      }
      #tool-toggle {
        width: 40px;
        height: 40px;
        font-size: 1.1em;
        left: 4px;
        bottom: 64px;
      }
      #fullscreen-btn, #zoom-in-btn, #zoom-out-btn, #mute-btn, #craft-btn, #save-btn, #load-btn {
        width: 36px;
        height: 36px;
        font-size: 1em;
        right: 4px;
      }
      #fullscreen-btn { bottom: 4px; }
      #zoom-in-btn { bottom: 44px; }
      #zoom-out-btn { bottom: 84px; }
      #mute-btn { bottom: 124px; }
      #craft-btn { bottom: 164px; }
      #save-btn { bottom: 204px; }
      #load-btn { bottom: 244px; }
      #crafting-modal {
        min-width: 180px;
        min-height: 120px;
        padding: 12px 6px 6px 6px;
      }
      #mobile-controls {
        height: 80px;
      }
      .joystick {
        width: 70px;
        height: 70px;
      }
      .joystick-inner {
        width: 32px;
        height: 32px;
        left: 19px;
        top: 19px;
      }
      .mobile-btn {
        width: 40px;
        height: 40px;
        font-size: 1.3em;
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
    <div id="toolbar"></div>
    <button id="tool-toggle" title="Toggle Tool">‚õèÔ∏è</button>
    <button id="fullscreen-btn" title="Fullscreen">‚õ∂</button>
    <button id="zoom-in-btn" title="Zoom In">Ôºã</button>
    <button id="zoom-out-btn" title="Zoom Out">Ôºç</button>
    <button id="mute-btn" title="Mute">üîä</button>
    <button id="craft-btn" title="Crafting">üõ†Ô∏è</button>
    <button id="save-btn" title="Save">üíæ</button>
    <button id="load-btn" title="Load">üìÇ</button>
    <div id="crafting-modal">
      <h2>Crafting</h2>
      <div id="crafting-list"></div>
      <button id="close-crafting">Close</button>
    </div>
    <div id="mobile-controls">
      <div class="joystick" id="joystick">
        <div class="joystick-inner" id="joystick-inner"></div>
      </div>
      <div class="mobile-btns">
        <button class="mobile-btn" id="jump-btn" title="Jump">‚¨ÜÔ∏è</button>
        <button class="mobile-btn" id="interact-btn" title="Interact">‚úã</button>
      </div>
    </div>
  </div>
  <audio id="audio-break" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b7e2b2.mp3" preload="auto"></audio>
  <audio id="audio-place" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b7e2b2.mp3" preload="auto"></audio>
  <audio id="audio-walk" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b7e2b2.mp3" preload="auto"></audio>
  <audio id="audio-music" src="https://cdn.pixabay.com/audio/2022/10/16/audio_12b6b7e2b2.mp3" preload="auto" loop></audio>
  <script>
// --- Block Types ---
const BLOCKS = [
  { id: 0, name: 'Air', color: 'rgba(0,0,0,0)', solid: false },
  { id: 1, name: 'Grass', color: '#5dbb63', solid: true },
  { id: 2, name: 'Dirt', color: '#a0522d', solid: true },
  { id: 3, name: 'Stone', color: '#888', solid: true },
  { id: 4, name: 'Wood', color: '#b8860b', solid: true },
  { id: 5, name: 'Water', color: '#3fa9f5', solid: false },
  { id: 6, name: 'Sand', color: '#f4e285', solid: true },
  { id: 7, name: 'Brick', color: '#b22222', solid: true },
];
const BLOCK_ID = {
  AIR: 0, GRASS: 1, DIRT: 2, STONE: 3, WOOD: 4, WATER: 5, SAND: 6, BRICK: 7
};

// --- Crafting Recipes ---
const RECIPES = [
  { output: 'Brick', count: 4, recipe: { Stone: 2, Dirt: 2 } },
  { output: 'Wood', count: 2, recipe: { Grass: 1, Dirt: 1 } },
  { output: 'Pickaxe', count: 1, recipe: { Wood: 2, Stone: 3 } },
  { output: 'Sand', count: 2, recipe: { Dirt: 1, Water: 1 } },
];

// --- World Settings ---
const CHUNK_SIZE = 32;
const WORLD_WIDTH = 128;
const WORLD_HEIGHT = 64;
const SKY_HEIGHT = 24;
const BLOCK_SIZE_BASE = 32;
let BLOCK_SIZE = BLOCK_SIZE_BASE;

// --- Player Settings ---
const PLAYER_SIZE = 0.8;
const PLAYER_JUMP = 8;
const PLAYER_SPEED = 0.18;
const GRAVITY = 0.38;
const MAX_FALL = 8;

// --- Game State ---
let world = [];
let inventory = {};
let player = {
  x: 10,
  y: 10,
  vx: 0,
  vy: 0,
  onGround: false,
  facing: 1,
};
let selectedBlock = BLOCK_ID.GRASS;
let toolMode = 'pickaxe';
let isMuted = false;
let isFullscreen = false;
let dayTime = 0; // 0..1
let weather = null;
let weatherTimer = 0;
let stars = [];
let sunMoonAngle = 0;
let camera = { x: 0, y: 0 };
let keys = {};
let mobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
let joystick = { active: false, dx: 0, dy: 0 };
let lastSave = null;

// --- Canvas Setup ---
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  BLOCK_SIZE = Math.max(16, Math.min(BLOCK_SIZE_BASE * (window.innerWidth/900), 48));
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// --- World Generation ---
function genWorld() {
  world = [];
  for (let x = 0; x < WORLD_WIDTH; x++) {
    world[x] = [];
    let surface = SKY_HEIGHT + Math.floor(Math.sin(x/8)*2 + Math.random()*2);
    for (let y = 0; y < WORLD_HEIGHT; y++) {
      if (y < surface-1) world[x][y] = BLOCK_ID.AIR;
      else if (y === surface-1) world[x][y] = BLOCK_ID.GRASS;
      else if (y < surface+2) world[x][y] = BLOCK_ID.DIRT;
      else if (y < WORLD_HEIGHT-2) world[x][y] = Math.random()<0.1?BLOCK_ID.STONE:BLOCK_ID.DIRT;
      else world[x][y] = BLOCK_ID.STONE;
      if (y > surface+2 && Math.random()<0.02) world[x][y] = BLOCK_ID.WATER;
      if (y > surface+2 && Math.random()<0.01) world[x][y] = BLOCK_ID.SAND;
    }
  }
}

// --- Save/Load ---
function saveWorld() {
  localStorage.setItem('minicraft_world', JSON.stringify(world));
  localStorage.setItem('minicraft_inventory', JSON.stringify(inventory));
  localStorage.setItem('minicraft_player', JSON.stringify(player));
  lastSave = Date.now();
  showToast('World saved!');
}
function loadWorld() {
  let w = localStorage.getItem('minicraft_world');
  let inv = localStorage.getItem('minicraft_inventory');
  let pl = localStorage.getItem('minicraft_player');
  if (w && inv && pl) {
    world = JSON.parse(w);
    inventory = JSON.parse(inv);
    player = JSON.parse(pl);
    showToast('World loaded!');
  } else {
    genWorld();
    showToast('New world generated!');
  }
}

// --- Inventory ---
function addToInventory(block, count=1) {
  if (!inventory[block]) inventory[block] = 0;
  inventory[block] += count;
  updateToolbar();
}
function removeFromInventory(block, count=1) {
  if (!inventory[block]) return false;
  if (inventory[block] < count) return false;
  inventory[block] -= count;
  updateToolbar();
  return true;
}
function hasInInventory(block, count=1) {
  return inventory[block] && inventory[block] >= count;
}

// --- Toolbar UI ---
const toolbar = document.getElementById('toolbar');
function updateToolbar() {
  toolbar.innerHTML = '';
  BLOCKS.forEach((b, i) => {
    if (b.id === 0) return;
    let el = document.createElement('div');
    el.className = 'toolbar-block' + (selectedBlock===b.id?' selected':'');
    el.title = b.name;
    el.style.background = b.color;
    if (inventory[b.name]) {
      let count = document.createElement('span');
      count.className = 'count';
      count.textContent = inventory[b.name];
      el.appendChild(count);
    }
    el.onclick = () => { selectedBlock = b.id; updateToolbar(); };
    toolbar.appendChild(el);
  });
}

// --- Tool Toggle ---
const toolToggle = document.getElementById('tool-toggle');
toolToggle.onclick = () => {
  toolMode = (toolMode==='pickaxe')?'block':'pickaxe';
  toolToggle.textContent = toolMode==='pickaxe'?'‚õèÔ∏è':'üß±';
  toolToggle.classList.toggle('active', toolMode==='block');
};

// --- Sound ---
const audioBreak = document.getElementById('audio-break');
const audioPlace = document.getElementById('audio-place');
const audioWalk = document.getElementById('audio-walk');
const audioMusic = document.getElementById('audio-music');
function playSound(audio) {
  if (!isMuted) {
    audio.currentTime = 0;
    audio.play();
  }
}
function playMusic() {
  if (!isMuted) {
    audioMusic.volume = 0.2;
    audioMusic.play();
  } else {
    audioMusic.pause();
  }
}

// --- Mute ---
const muteBtn = document.getElementById('mute-btn');
muteBtn.onclick = () => {
  isMuted = !isMuted;
  muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
  playMusic();
};

// --- Fullscreen ---
const fullscreenBtn = document.getElementById('fullscreen-btn');
fullscreenBtn.onclick = () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    isFullscreen = true;
  } else {
    document.exitFullscreen();
    isFullscreen = false;
  }
};

document.addEventListener('fullscreenchange', () => {
  isFullscreen = !!document.fullscreenElement;
});

// --- Zoom ---
const zoomInBtn = document.getElementById('zoom-in-btn');
const zoomOutBtn = document.getElementById('zoom-out-btn');
zoomInBtn.onclick = () => {
  BLOCK_SIZE = Math.min(BLOCK_SIZE+8, 64);
};
zoomOutBtn.onclick = () => {
  BLOCK_SIZE = Math.max(BLOCK_SIZE-8, 16);
};

// --- Save/Load Buttons ---
document.getElementById('save-btn').onclick = saveWorld;
document.getElementById('load-btn').onclick = loadWorld;

// --- Crafting ---
const craftBtn = document.getElementById('craft-btn');
const craftingModal = document.getElementById('crafting-modal');
const craftingList = document.getElementById('crafting-list');
const closeCrafting = document.getElementById('close-crafting');
craftBtn.onclick = () => {
  updateCraftingList();
  craftingModal.classList.add('active');
};
closeCrafting.onclick = () => {
  craftingModal.classList.remove('active');
};
function updateCraftingList() {
  craftingList.innerHTML = '';
  RECIPES.forEach(r => {
    let canCraft = Object.entries(r.recipe).every(([k,v]) => hasInInventory(k,v));
    let el = document.createElement('div');
    el.className = 'craft-item' + (canCraft?'':' disabled');
    el.innerHTML = `<span>${r.output} √ó${r.count}</span><span class="recipe">${Object.entries(r.recipe).map(([k,v])=>k+':'+v).join(', ')}</span>`;
    if (canCraft) {
      el.onclick = () => {
        Object.entries(r.recipe).forEach(([k,v]) => removeFromInventory(k,v));
        addToInventory(r.output, r.count);
        updateCraftingList();
        updateToolbar();
        showToast('Crafted '+r.output+'!');
      };
    }
    craftingList.appendChild(el);
  });
}

// --- Toast ---
let toastTimeout = null;
function showToast(msg) {
  let el = document.getElementById('toast');
  if (!el) {
    el = document.createElement('div');
    el.id = 'toast';
    el.style.position = 'fixed';
    el.style.left = '50%';
    el.style.bottom = '100px';
    el.style.transform = 'translateX(-50%)';
    el.style.background = 'var(--ui-bg)';
    el.style.color = 'var(--ui-fg)';
    el.style.padding = '10px 24px';
    el.style.borderRadius = '12px';
    el.style.fontSize = '1.1em';
    el.style.zIndex = 200;
    el.style.boxShadow = '0 2px 8px #0006';
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(()=>{el.style.display='none';}, 1800);
}

// --- Mobile Controls ---
const mobileControls = document.getElementById('mobile-controls');
const joystickEl = document.getElementById('joystick');
const joystickInner = document.getElementById('joystick-inner');
const jumpBtn = document.getElementById('jump-btn');
const interactBtn = document.getElementById('interact-btn');
if (!mobile) mobileControls.style.display = 'none';

// --- Joystick ---
let joyStart = null;
joystickEl.addEventListener('touchstart', e => {
  joyStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  joystick.active = true;
}, {passive:false});
joystickEl.addEventListener('touchmove', e => {
  if (!joyStart) return;
  let dx = e.touches[0].clientX - joyStart.x;
  let dy = e.touches[0].clientY - joyStart.y;
  let dist = Math.sqrt(dx*dx+dy*dy);
  if (dist > 40) {
    dx *= 40/dist;
    dy *= 40/dist;
  }
  joystick.dx = dx/40;
  joystick.dy = dy/40;
  joystickInner.style.left = (26+dx)+'px';
  joystickInner.style.top = (26+dy)+'px';
}, {passive:false});
joystickEl.addEventListener('touchend', e => {
  joystick.active = false;
  joystick.dx = 0;
  joystick.dy = 0;
  joystickInner.style.left = '26px';
  joystickInner.style.top = '26px';
}, {passive:false});

jumpBtn.addEventListener('touchstart', e => { keys[' '] = true; });
jumpBtn.addEventListener('touchend', e => { keys[' '] = false; });
interactBtn.addEventListener('touchstart', e => { interactAtPlayer(); });

// --- Keyboard Controls ---
document.addEventListener('keydown', e => {
  keys[e.key] = true;
});
document.addEventListener('keyup', e => {
  keys[e.key] = false;
});

// --- Mouse/Touch Controls ---
canvas.addEventListener('mousedown', e => {
  let wx = Math.floor((e.offsetX + camera.x)/BLOCK_SIZE);
  let wy = Math.floor((e.offsetY + camera.y)/BLOCK_SIZE);
  interactAt(wx, wy);
});
canvas.addEventListener('touchstart', e => {
  let rect = canvas.getBoundingClientRect();
  let tx = e.touches[0].clientX - rect.left;
  let ty = e.touches[0].clientY - rect.top;
  let wx = Math.floor((tx + camera.x)/BLOCK_SIZE);
  let wy = Math.floor((ty + camera.y)/BLOCK_SIZE);
  interactAt(wx, wy);
});
function interactAt(x, y) {
  if (toolMode==='pickaxe') {
    if (world[x] && world[x][y] && world[x][y]!==BLOCK_ID.AIR) {
      addToInventory(BLOCKS[world[x][y]].name, 1);
      world[x][y] = BLOCK_ID.AIR;
      playSound(audioBreak);
    }
  } else {
    if (world[x] && world[x][y] && world[x][y]===BLOCK_ID.AIR && hasInInventory(BLOCKS[selectedBlock].name, 1)) {
      world[x][y] = selectedBlock;
      removeFromInventory(BLOCKS[selectedBlock].name, 1);
      playSound(audioPlace);
    }
  }
}
function interactAtPlayer() {
  let px = Math.floor(player.x+0.5);
  let py = Math.floor(player.y+1.2);
  interactAt(px, py);
}

// --- Player Movement ---
function updatePlayer(dt) {
  let move = 0;
  if (mobile && joystick.active) {
    move = joystick.dx;
  } else {
    if (keys['ArrowLeft']||keys['a']) move -= 1;
    if (keys['ArrowRight']||keys['d']) move += 1;
  }
  player.vx = move * PLAYER_SPEED * (BLOCK_SIZE/32);
  if ((keys['ArrowUp']||keys['w']||keys[' ']) && player.onGround) {
    player.vy = -PLAYER_JUMP * (BLOCK_SIZE/32)/2.5;
    player.onGround = false;
    playSound(audioWalk);
  }
  player.vy += GRAVITY * (BLOCK_SIZE/32);
  if (player.vy > MAX_FALL) player.vy = MAX_FALL;
  let nx = player.x + player.vx;
  let ny = player.y + player.vy;
  // Collision
  if (isSolid(nx, player.y)) {
    nx = player.x;
    player.vx = 0;
  }
  if (isSolid(player.x, ny+PLAYER_SIZE/2)) {
    if (player.vy > 0) player.onGround = true;
    player.vy = 0;
    ny = Math.floor(ny+PLAYER_SIZE/2)-PLAYER_SIZE/2;
  } else {
    player.onGround = false;
  }
  player.x = Math.max(0, Math.min(WORLD_WIDTH-1, nx));
  player.y = Math.max(0, Math.min(WORLD_HEIGHT-PLAYER_SIZE, ny));
  if (move!==0) player.facing = move>0?1:-1;
}
function isSolid(x, y) {
  let bx = Math.floor(x);
  let by = Math.floor(y+PLAYER_SIZE/2);
  if (world[bx] && world[bx][by]) {
    return BLOCKS[world[bx][by]].solid;
  }
  return false;
}

// --- Camera ---
function updateCamera() {
  camera.x = player.x*BLOCK_SIZE - canvas.width/2 + BLOCK_SIZE/2;
  camera.y = player.y*BLOCK_SIZE - canvas.height/2 + BLOCK_SIZE/2;
  camera.x = Math.max(0, Math.min(camera.x, WORLD_WIDTH*BLOCK_SIZE-canvas.width));
  camera.y = Math.max(0, Math.min(camera.y, WORLD_HEIGHT*BLOCK_SIZE-canvas.height));
}

// --- Day/Night Cycle ---
function updateDayNight(dt) {
  dayTime += dt/60000; // 1 min = full cycle
  if (dayTime > 1) dayTime -= 1;
  sunMoonAngle = dayTime * 2 * Math.PI;
}
function getSkyColor() {
  let t = Math.abs(Math.sin(sunMoonAngle/2));
  let day = [135,206,235];
  let night = [26,35,64];
  let c = day.map((v,i)=>Math.round(v*(1-t)+night[i]*t));
  return `rgb(${c[0]},${c[1]},${c[2]})`;
}

// --- Weather ---
function updateWeather(dt) {
  if (!weather && Math.random()<0.0005) {
    weather = Math.random()<0.5?'rain':'snow';
    weatherTimer = 10000+Math.random()*10000;
  }
  if (weather) {
    weatherTimer -= dt;
    if (weatherTimer<=0) weather = null;
  }
}
function drawWeather() {
  if (weather==='rain') {
    for (let i=0;i<60;i++) {
      let x = Math.random()*canvas.width;
      let y = Math.random()*canvas.height;
      ctx.strokeStyle = 'var(--rain-color)';
      ctx.beginPath();
      ctx.moveTo(x,y);
      ctx.lineTo(x+2,y+12);
      ctx.stroke();
    }
  } else if (weather==='snow') {
    for (let i=0;i<40;i++) {
      let x = Math.random()*canvas.width;
      let y = Math.random()*canvas.height;
      ctx.fillStyle = 'var(--snow-color)';
      ctx.beginPath();
      ctx.arc(x,y,2,0,2*Math.PI);
      ctx.fill();
    }
  }
}

// --- Stars ---
function genStars() {
  stars = [];
  for (let i=0;i<80;i++) {
    stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.2+0.3});
  }
}

// --- Render ---
function render() {
  // Sky
  ctx.fillStyle = getSkyColor();
  ctx.fillRect(0,0,canvas.width,canvas.height);
  // Sun/Moon
  let sunX = canvas.width/2 + Math.cos(sunMoonAngle-Math.PI/2)*canvas.width/2.2;
  let sunY = canvas.height/2 + Math.sin(sunMoonAngle-Math.PI/2)*canvas.height/2.2;
  ctx.beginPath();
  ctx.arc(sunX,sunY,36,0,2*Math.PI);
  ctx.fillStyle = 'var(--sun-color)';
  ctx.globalAlpha = Math.max(0,Math.cos(sunMoonAngle));
  ctx.fill();
  ctx.globalAlpha = 1;
  // Moon
  let moonX = canvas.width/2 + Math.cos(sunMoonAngle+Math.PI)*canvas.width/2.2;
  let moonY = canvas.height/2 + Math.sin(sunMoonAngle+Math.PI)*canvas.height/2.2;
  ctx.beginPath();
  ctx.arc(moonX,moonY,28,0,2*Math.PI);
  ctx.fillStyle = 'var(--moon-color)';
  ctx.globalAlpha = Math.max(0,Math.sin(sunMoonAngle));
  ctx.fill();
  ctx.globalAlpha = 1;
  // Stars
  if (Math.sin(sunMoonAngle)>0.2) {
    ctx.globalAlpha = Math.min(1,Math.sin(sunMoonAngle));
    stars.forEach(s=>{
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,2*Math.PI);
      ctx.fillStyle = 'var(--star-color)';
      ctx.fill();
    });
    ctx.globalAlpha = 1;
  }
  // Weather
  drawWeather();
  // World
  let bx0 = Math.floor(camera.x/BLOCK_SIZE);
  let by0 = Math.floor(camera.y/BLOCK_SIZE);
  let bx1 = Math.ceil((camera.x+canvas.width)/BLOCK_SIZE);
  let by1 = Math.ceil((camera.y+canvas.height)/BLOCK_SIZE);
  for (let x=bx0;x<bx1;x++) {
    for (let y=by0;y<by1;y++) {
      if (world[x] && world[x][y] && world[x][y]!==BLOCK_ID.AIR) {
        ctx.fillStyle = BLOCKS[world[x][y]].color;
        ctx.fillRect(
          Math.floor(x*BLOCK_SIZE-camera.x),
          Math.floor(y*BLOCK_SIZE-camera.y),
          BLOCK_SIZE,BLOCK_SIZE
        );
        // Block border
        ctx.strokeStyle = '#0003';
        ctx.strokeRect(
          Math.floor(x*BLOCK_SIZE-camera.x),
          Math.floor(y*BLOCK_SIZE-camera.y),
          BLOCK_SIZE,BLOCK_SIZE
        );
      }
    }
  }
  // Player
  ctx.save();
  ctx.translate(
    Math.floor(player.x*BLOCK_SIZE-camera.x+BLOCK_SIZE/2),
    Math.floor(player.y*BLOCK_SIZE-camera.y+BLOCK_SIZE/2)
  );
  ctx.scale(player.facing,1);
  ctx.fillStyle = '#fff';
  ctx.beginPath();
  ctx.arc(0,0,BLOCK_SIZE*PLAYER_SIZE/2,0,2*Math.PI);
  ctx.fill();
  ctx.strokeStyle = '#222';
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = '#222';
  ctx.beginPath();
  ctx.arc(-BLOCK_SIZE*0.12,-BLOCK_SIZE*0.1,BLOCK_SIZE*0.08,0,2*Math.PI);
  ctx.arc(BLOCK_SIZE*0.12,-BLOCK_SIZE*0.1,BLOCK_SIZE*0.08,0,2*Math.PI);
  ctx.fill();
  ctx.restore();
}

// --- Main Loop ---
let lastTime = performance.now();
function gameLoop(now) {
  let dt = now - lastTime;
  lastTime = now;
  updatePlayer(dt);
  updateCamera();
  updateDayNight(dt);
  updateWeather(dt);
  render();
  requestAnimationFrame(gameLoop);
}

// --- Init ---
function init() {
  loadWorld();
  updateToolbar();
  genStars();
  playMusic();
  requestAnimationFrame(gameLoop);
}
window.onload = init;

// --- Save on exit ---
window.addEventListener('beforeunload', saveWorld);
  </script>
</body>
</html>
